<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda RPG Cloud</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-paper: #f4e4bc;
            --text-color: #2c1a0b;
            --accent-red: #8a1c1c;
            --accent-green: #27ae60;
            --accent-gold: #c5a00bd7;
            --dark-border: #462c18;
            --input-bg: rgba(255,255,255,0.4);
        }

        body {
            background-color: #1a1a1a;
            background-image: radial-gradient(circle, #2a2a2a 0%, #1a1a1a 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            font-family: 'MedievalSharp', cursive;
            padding: 10px;
            color: var(--text-color);
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        /* --- STILE PERGAMENA UNIFICATO --- */
        .paper-panel {
            background-color: var(--bg-paper);
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.1);
            border: 10px solid var(--dark-border);
            position: relative;
            margin-bottom: 20px;
            display: none; /* Nascosto di default */
            animation: fadeIn 0.5s;
        }
        .paper-panel.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        h1 { 
            text-align: center; 
            color: var(--text-color); 
            border-bottom: 2px solid var(--text-color); 
            margin-top: 0; 
            padding-bottom: 10px;
        }

        /* --- UI ELEMENTI (SETUP) --- */
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }

        input {
            width: 100%; padding: 10px; margin-bottom: 15px;
            background: var(--input-bg); border: 2px solid var(--dark-border);
            font-family: inherit; font-size: 1.1rem; box-sizing: border-box;
            color: var(--text-color); border-radius: 4px;
        }

        button {
            background-color: var(--text-color); color: var(--bg-paper);
            border: none; padding: 12px; width: 100%;
            font-family: inherit; cursor: pointer; font-size: 1rem;
            margin-top: 10px; border-radius: 5px;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.95); }
        button:hover { opacity: 0.9; }

        /* --- STATUS BAR --- */
        .status-bar {
            position: absolute; top: -30px; right: 0;
            font-size: 0.75rem; display: flex; align-items: center; gap: 6px;
            background: rgba(0,0,0,0.6); padding: 4px 8px;
            border-radius: 12px; color: #ddd;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; transition: background 0.3s; }
        .dot.online { background: var(--accent-green); box-shadow: 0 0 6px var(--accent-green); }
        .dot.offline { background: #e74c3c; }

        /* --- GAME UI (Dal File B) --- */
        .avatar { text-align: center; font-size: 1.1rem; margin-bottom: 20px; color: #555; font-style: italic; }

        .stats-grid { 
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; 
            margin-bottom: 20px; text-align: center; 
        }
        .stat-box { 
            border: 2px solid var(--text-color); padding: 10px; 
            border-radius: 8px; background: rgba(255,255,255,0.3); 
        }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; }

        .level-section {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.05); padding: 10px;
            border-radius: 5px; margin-bottom: 20px; border: 1px dashed var(--dark-border);
        }
        .btn-small { width: auto; padding: 5px 15px; margin: 0; }

        /* HP Bar stile File B */
        .hp-container { margin-bottom: 20px; }
        .hp-bar-bg {
            background-color: #555; height: 30px; border-radius: 15px;
            overflow: hidden; border: 2px solid var(--text-color);
            position: relative;
        }
        .hp-bar-fill {
            background-color: var(--accent-red); height: 100%; width: 100%;
            transition: width 0.3s ease, background-color 0.3s;
        }
        .hp-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: white;
            font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 0.9rem;
            white-space: nowrap; z-index: 2;
        }

        /* Controls stile File B */
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button.heal { background-color: #2ecc71; color: black; }
        button.damage { background-color: #c0392b; color: white; }

        /* Party List (Cloud) */
        .party-list { margin-top: 25px; border-top: 2px dashed var(--dark-border); padding-top: 15px; }
        .party-title { text-align: center; font-size: 0.9rem; font-weight: bold; opacity: 0.7; margin-bottom: 10px; text-transform: uppercase; }
        .party-member { 
            padding: 8px; border-bottom: 1px solid rgba(70, 44, 24, 0.2); 
            display: flex; justify-content: space-between; font-size: 0.9rem;
        }

        .config-warning {
            background: #f1c40f; color: #4a3b10; padding: 10px;
            font-size: 0.85rem; text-align: center; border: 2px solid #d35400;
            margin-bottom: 15px; display: none; border-radius: 4px;
        }
        
        #logMsg { text-align: center; font-size: 0.9rem; margin-top: 15px; opacity: 0.7; font-style: italic; min-height: 1.2em;}

    </style>
</head>
<body>

<div class="app-container">
    
    <!-- STATUS INDICATOR -->
    <div class="status-bar">
        <div id="statusDot" class="dot"></div>
        <span id="statusText">Inizializzazione...</span>
    </div>

    <!-- PANNELLO SETUP (File A logic, File B style) -->
    <div id="setupPanel" class="paper-panel active">
        <h1>Nuovo Eroe</h1>
        
        <div id="configWarning" class="config-warning">
            <strong>MODALITÀ OFFLINE</strong><br>
            Nessun cloud rilevato. Gioco in locale.
        </div>

        <label>Nome Eroe</label>
        <input type="text" id="inputName" value="Valeros" placeholder="Es. Gandalf">
        
        <label>Classe & Razza</label>
        <input type="text" id="inputClass" value="Guerriero Umano" placeholder="Es. Elfo Mago">
        
        <label>Codice Stanza (Multiplayer)</label>
        <input type="text" id="inputRoom" placeholder="Es. TAVERNA" style="text-transform:uppercase; text-align:center; letter-spacing:2px; font-weight:bold; color: var(--accent-red);">

        <button onclick="startGame()">ENTRA NELL'AVVENTURA</button>
    </div>

    <!-- PANNELLO GIOCO (Layout File B) -->
    <div id="gamePanel" class="paper-panel">
        
        <div style="text-align:center; font-size:0.7rem; margin-bottom:5px; opacity:0.6; letter-spacing:1px;" id="roomDisplay">ROOM: ???</div>

        <h1 id="charNameDisplay">Nome Personaggio</h1>
        <div class="avatar" id="charClassDisplay">Classe Razza</div>

        <div class="stats-grid">
            <div class="stat-box">
                <div class="stat-value" id="dispStr">10</div>
                <div class="stat-label">Forza (STR)</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="dispDmg">10</div>
                <div class="stat-label">Danni Base</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="dispAc">10</div>
                <div class="stat-label">Armatura (AC)</div>
            </div>
        </div>

        <div class="level-section">
            <span style="font-weight:bold;">LIVELLO <span id="dispLvl" style="font-size:1.4rem; margin-left:5px;">1</span></span>
            <div>
                <button class="btn-small" onclick="changeLevel(-1)">-</button>
                <button class="btn-small" onclick="changeLevel(1)">+</button>
            </div>
        </div>

        <div class="hp-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold;">
                <span>Punti Ferita</span>
                <span><span id="dispHp">20</span> / <span id="dispMaxHp">20</span></span>
            </div>
            <div class="hp-bar-bg">
                <div class="hp-bar-fill" id="hpBar"></div>
                <!-- Testo centrato sulla barra rimosso per pulizia visiva (già sopra), o mantenibile se preferito -->
            </div>
        </div>

        <div class="controls">
            <button class="damage" onclick="updateHP(-5)">DANNI (-5)</button>
            <button class="heal" onclick="updateHP(5)">CURA (+5)</button>
        </div>
        
        <p id="logMsg">Benvenuto nel regno.</p>

        <!-- Sezione Multiplayer (Cloud) -->
        <div class="party-list">
            <div class="party-title">Compagni nella Stanza</div>
            <div id="partyListContainer">
                <div style="text-align:center; opacity:0.5; font-size:0.8rem; margin-top:10px;">Nessuno qui...</div>
            </div>
        </div>

        <button onclick="location.reload()" style="background:transparent; color:#5d4037; border:1px solid #5d4037; margin-top:30px; font-size:0.8rem; padding:8px;">Esci dalla partita</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ==================================================================================
    // ⬇️ ⬇️ ⬇️  CONFIGURAZIONE FIREBASE  ⬇️ ⬇️ ⬇️
    // ==================================================================================
    
    // Per esportare l'app: Sostituisci 'null' con il tuo oggetto config tra le graffe.
    const PERMANENT_CONFIG = null; 
    
    // ==================================================================================
    // ⬆️ ⬆️ ⬆️  FINE CONFIGURAZIONE  ⬆️ ⬆️ ⬆️
    // ==================================================================================

    // --- VARIABILI GLOBALI ---
    let app, auth, db;
    let isOnline = false;
    let currentUser = null;
    let myDocRef = null;
    let unsubscribeParty = null;
    let appIdStr = 'default-app-id';

    // Gestione Configurazione
    let activeConfig = PERMANENT_CONFIG;
    if (!activeConfig && typeof __firebase_config !== 'undefined') {
        try {
            activeConfig = JSON.parse(__firebase_config);
            if (typeof __app_id !== 'undefined') appIdStr = __app_id;
        } catch (e) { console.error(e); }
    }

    // --- INIZIALIZZAZIONE ---
    if (activeConfig) {
        try {
            app = initializeApp(activeConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            isOnline = true;
            
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            initAuth();
            
            onAuthStateChanged(auth, user => {
                if(user) {
                    currentUser = user;
                    updateStatus(true);
                    if (document.getElementById('gamePanel').classList.contains('active')) {
                        joinRoom(charData.room);
                    }
                } else {
                    updateStatus(false, "Disconnesso");
                }
            });
        } catch (e) {
            updateStatus(false, "Err Init");
            document.getElementById('configWarning').style.display = 'block';
        }
    } else {
        document.getElementById('configWarning').style.display = 'block';
        updateStatus(false);
    }

    // --- STATO DEL PERSONAGGIO ---
    let charData = {
        name: "Valeros",
        class: "Guerriero",
        room: "TAVERNA",
        level: 1,
        maxHp: 20,
        currentHp: 20,
        str: 10,
        baseDmg: 10,
        baseAc: 10
    };

    // --- UI FUNCTIONS ---
    window.startGame = async function() {
        if (isOnline && !currentUser) {
            log("Connessione in corso...");
            setTimeout(() => {
                if(!currentUser) alert("Attendere la connessione al cloud...");
                else proceedStart();
            }, 1000);
            return;
        }
        proceedStart();
    };

    function proceedStart() {
        // Prendi dati dal setup
        charData.name = document.getElementById('inputName').value || "Eroe";
        charData.class = document.getElementById('inputClass').value || "Avventuriero";
        let roomVal = document.getElementById('inputRoom').value.trim();
        charData.room = (roomVal || "TAVERNA").toUpperCase();

        // Switch pannelli
        document.getElementById('setupPanel').classList.remove('active');
        document.getElementById('gamePanel').classList.add('active');
        
        // Imposta UI statica
        document.getElementById('charNameDisplay').innerText = charData.name;
        document.getElementById('charClassDisplay').innerText = charData.class;
        document.getElementById('roomDisplay').innerText = "STANZA: " + charData.room;

        render();

        if (isOnline && currentUser) {
            joinRoom(charData.room);
        }
    }

    // --- LOGICA DI GIOCO (Regole File B integrate) ---
    window.changeLevel = function(delta) {
        const oldLvl = charData.level;
        charData.level += delta;
        if(charData.level < 1) charData.level = 1;

        if(charData.level > oldLvl) { // Level Up
            charData.maxHp += 8; // Regola File B
            charData.currentHp += 8;
            if(charData.level % 4 === 0) charData.str += 1; // Regola File B
            log("LEVEL UP! Sei diventato più forte.");
        } else if (charData.level < oldLvl) { // Level Down
            charData.maxHp -= 8;
            if(charData.currentHp > charData.maxHp) charData.currentHp = charData.maxHp;
            if(oldLvl % 4 === 0) charData.str -= 1;
            log("Livello perso...");
        }
        render();
        sync();
    }

    window.updateHP = function(delta) {
        charData.currentHp += delta;
        if(charData.currentHp > charData.maxHp) charData.currentHp = charData.maxHp;
        if(charData.currentHp < 0) charData.currentHp = 0;
        
        if (delta < 0) log(`Hai subito ${Math.abs(delta)} danni!`);
        else log(`Ti sei curato di ${delta} HP.`);

        render();
        sync();
    }

    function log(msg) {
        const elLog = document.getElementById('logMsg');
        elLog.innerText = msg;
        elLog.style.opacity = 1;
        setTimeout(() => { elLog.style.opacity = 0.7; }, 2000);
    }

    function render() {
        // Calcolo stats derivate
        let strMod = Math.floor((charData.str - 10) / 2);
        let dmg = charData.baseDmg + strMod + Math.floor(charData.level / 2);
        let ac = charData.baseAc + Math.floor(charData.level / 2);

        // Update DOM
        document.getElementById('dispLvl').innerText = charData.level;
        document.getElementById('dispStr').innerText = charData.str;
        document.getElementById('dispDmg').innerText = dmg;
        document.getElementById('dispAc').innerText = ac;
        
        document.getElementById('dispHp').innerText = charData.currentHp;
        document.getElementById('dispMaxHp').innerText = charData.maxHp;

        // Barra HP
        let pct = (charData.currentHp / charData.maxHp) * 100;
        pct = Math.max(0, Math.min(100, pct)); 
        
        const bar = document.getElementById('hpBar');
        bar.style.width = pct + "%";
        
        if(pct < 30) bar.style.backgroundColor = "#c0392b"; // Rosso critico
        else bar.style.backgroundColor = "#8a1c1c"; // Rosso normale
    }

    // --- FIREBASE SYNC (Invariato da File A per funzionamento Cloud) ---
    async function joinRoom(room) {
        if(!isOnline || !currentUser) return;

        const collectionPath = collection(db, 'artifacts', appIdStr, 'public', 'data', 'rpg_players');
        const docId = `${room}_${currentUser.uid}`;
        myDocRef = doc(db, 'artifacts', appIdStr, 'public', 'data', 'rpg_players', docId);
        
        await sync();

        const q = query(collectionPath, where("room", "==", room));
        if (unsubscribeParty) unsubscribeParty();

        unsubscribeParty = onSnapshot(q, (snapshot) => {
            const list = document.getElementById('partyListContainer');
            list.innerHTML = "";
            let count = 0;
            snapshot.forEach(d => {
                if(d.id !== docId) { 
                    const p = d.data();
                    const pDiv = document.createElement('div');
                    pDiv.className = 'party-member';
                    const hpPct = (p.currentHp / p.maxHp);
                    const hpColor = hpPct < 0.3 ? '#e74c3c' : '#27ae60';

                    pDiv.innerHTML = `
                        <div><strong>${p.name}</strong> (${p.level})</div>
                        <div style="color:${hpColor}; font-weight:bold;">${p.currentHp}/${p.maxHp}</div>`;
                    list.appendChild(pDiv);
                    count++;
                }
            });
            if(count === 0) list.innerHTML = "<div style='text-align:center; opacity:0.5; font-size:0.8rem; margin-top:10px;'>Sei solo in questa stanza...</div>";
        });
    }

    async function sync() {
        if(!isOnline || !myDocRef) return;
        try {
            await setDoc(myDocRef, {
                uid: currentUser.uid,
                room: charData.room,
                name: charData.name,
                class: charData.class,
                level: charData.level,
                currentHp: charData.currentHp,
                maxHp: charData.maxHp,
                str: charData.str,
                lastUpdate: Date.now()
            }, { merge: true });
        } catch(e) { console.error("Sync error", e); }
    }

    function updateStatus(online, msg) {
        const dot = document.getElementById('statusDot');
        const txt = document.getElementById('statusText');
        if(online) {
            dot.className = "dot online";
            txt.innerText = msg || "Online";
        } else {
            dot.className = "dot offline";
            txt.innerText = msg || "Offline";
        }
    }
</script>
</body>
</html>
